name: build

on:
  workflow_dispatch:
    inputs:
      clean:
        description: 'Clean build'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Config
      run: |
        [ -f config.android ] && cp config.android .config
        echo "y" | make oldconfig 2>/dev/null || true
        
    - name: NDK
      run: |
        if [ ! -d "android-ndk-r25b" ]; then
          wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip -q android-ndk-r25b-linux.zip
        fi
        
    - name: Compile
      run: |
        export CC="$(pwd)/android-ndk-r25b/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android30-clang"
        
        make CC="$CC" CFLAGS="-static -Os -DANDROID -DNO_CRYPT" -j4 2>&1 | tail -20
        
        [ -f toybox ] && mkdir -p out && cp toybox out/
        
    - name: Result
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: toybox
        path: out/
