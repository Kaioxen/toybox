name: Build Toybox for Android ARM64 -2026

on:
  workflow_dispatch:  
  push:
    branches: [main]
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: toybox-source
        
    - name: Show directory structure
      run: |
        echo "=== CURRENT DIRECTORY ==="
        pwd
        ls -la
        echo "=== TOYBOX SOURCE ==="
        cd toybox-source
        pwd
        ls -la
        
    - name: Download Android NDK
      run: |
        cd toybox-source
        echo "=== DOWNLOADING NDK ==="
        pwd
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
        unzip -q android-ndk-r25b-linux.zip
        echo "=== NDK CONTENTS ==="
        ls -la android-ndk-r25b/
        
    - name: Configure for Android
      run: |
        cd toybox-source
        echo "=== CONFIGURING ==="
        pwd
        
        # Setup environment
        export NDK="$PWD/android-ndk-r25b"
        export TOOLCHAIN="$NDK/toolchains/llvm/prebuilt/linux-x86_64"
        export CC="$TOOLCHAIN/bin/aarch64-linux-android30-clang"
        export STRIP="$TOOLCHAIN/bin/llvm-strip"
        
        echo "CC=$CC"
        echo "STRIP=$STRIP"
        ls -la "$TOOLCHAIN/bin/" | head -10
        
        # Configure
        make defconfig
        
        # Disable problematic features
        echo "CONFIG_STATIC=y" >> .config
        echo "CONFIG_ANDROID=y" >> .config
        echo "CONFIG_TOYBOX_PREFIX=\"/system/bin\"" >> .config
        echo "CONFIG_SU=n" >> .config
        echo "CONFIG_LOGIN=n" >> .config
        echo "CONFIG_PASSWD=n" >> .config
        echo "CONFIG_CHATTR=n" >> .config
        
        echo "=== CONFIG SUMMARY ==="
        grep -E "CONFIG_(STATIC|ANDROID|SU|LOGIN)" .config
        
    - name: Build Toybox
      run: |
        cd toybox-source
        echo "=== BUILDING ==="
        pwd
        
        export NDK="$PWD/android-ndk-r25b"
        export TOOLCHAIN="$NDK/toolchains/llvm/prebuilt/linux-x86_64"
        export CC="$TOOLCHAIN/bin/aarch64-linux-android30-clang"
        export STRIP="$TOOLCHAIN/bin/llvm-strip"
        
        make CC="$CC" \
             CFLAGS="-static -Os -DANDROID -DNO_CRYPT" \
             LDFLAGS="-static" \
             -j$(nproc)
        
        # Check if build succeeded
        if [ -f "toybox" ]; then
            echo "=== BUILD SUCCESS ==="
            # Strip
            $STRIP --strip-all toybox
            
            # Info
            echo "Binary info:"
            file toybox
            ls -lh toybox
            stat -c%s toybox
            
            # Quick test
            ./toybox echo "Build successful!"
            ./toybox ls -la | head -3
        else
            echo "=== BUILD FAILED ==="
            ls -la
            exit 1
        fi
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: toybox-android-arm64
        path: toybox-source/toybox
        retention-days: 30
