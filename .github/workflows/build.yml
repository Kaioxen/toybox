name: Compile

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  compile:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup config from config.android
      run: |
        echo "=== SETUP CONFIG ==="
        ls -la *.config* config.* 2>/dev/null || true
        
        if [ -f "config.android" ]; then
          echo "Copying config.android to .config"
          cp config.android .config
        else
          echo "ERROR: config.android not found!"
          ls -la
          exit 1
        fi
        
        echo "=== CONFIG CHECK ==="
        grep -E "CONFIG_(SU|LOGIN|PASSWD|STATIC|ANDROID)" .config
        
        echo "=== REGENERATE ==="
        make silentoldconfig
        
    - name: Get NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
        unzip -q android-ndk-r25b-linux.zip
        
    - name: Build
      run: |
        NDK="$PWD/android-ndk-r25b"
        CC="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android30-clang"
        STRIP="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
        
        echo "=== BUILDING ==="
        make CC="$CC" CFLAGS="-static -Os -DANDROID -DNO_CRYPT" LDFLAGS="-static" -j4
        
        if [ -f "toybox" ]; then
          echo "=== SUCCESS ==="
          $STRIP --strip-all toybox
          mkdir -p out
          cp toybox out/
          ls -lh out/
          file out/toybox
        else
          echo "=== BUILD FAILED ==="
          exit 1
        fi
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: toybox-android
        path: out/
